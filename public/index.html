<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriMeat ü•© - Comparador Nutricional de Carnes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
        .positive { color: #4CAF50; }
        .negative { color: #E53935; }
        canvas {
            max-width: 100%;
            margin: 20px 0;
        }
        .nav-tabs .nav-link {
            color: #0288D1;
        }
        .nav-tabs .nav-link.active {
            color: #03A9F4;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">NutriMeat ü•©</h1>
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="comparar-tab" data-bs-toggle="tab" data-bs-target="#comparar" type="button" role="tab">
                    Comparar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking" type="button" role="tab">
                    Ranking
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="objetivos-tab" data-bs-toggle="tab" data-bs-target="#objetivos" type="button" role="tab">
                    Objetivos
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Aba de Compara√ß√£o -->
            <div class="tab-pane fade show active" id="comparar" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Selecione as carnes para compara√ß√£o</h5>
                        <div class="row g-3" id="selectContainer"></div>
                        <button class="btn btn-primary mt-3" onclick="compararCarnes()">Comparar</button>
                    </div>
                </div>

                <div id="resultado" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Compara√ß√£o Nutricional</h5>
                            <div class="mb-3">
                                <button class="btn btn-success me-2" onclick="exportarPDF()">Exportar PDF</button>
                                <button class="btn btn-success" onclick="exportarExcel()">Exportar Excel</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="tabelaComparacao">
                                    <thead>
                                        <tr>
                                            <th>Nutriente</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Gr√°ficos Comparativos</h5>
                            <canvas id="graficoProteinas"></canvas>
                            <canvas id="graficoGorduras"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Ranking -->
            <div class="tab-pane fade" id="ranking" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Ranking por Nutriente</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <select class="form-select" id="nutrienteSelect">
                                    <option value="calorias">Calorias</option>
                                    <option value="proteinas">Prote√≠nas</option>
                                    <option value="gorduras_totais">Gorduras Totais</option>
                                    <option value="gorduras_saturadas">Gorduras Saturadas</option>
                                    <option value="colesterol">Colesterol</option>
                                    <option value="calcio">C√°lcio</option>
                                    <option value="ferro">Ferro</option>
                                    <option value="sodio">S√≥dio</option>
                                    <option value="zinco">Zinco</option>
                                    <option value="vitamina_b12">Vitamina B12</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="ordemSelect">
                                    <option value="desc">Maior para Menor</option>
                                    <option value="asc">Menor para Maior</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-3" onclick="gerarRanking()">Gerar Ranking</button>
                        <div id="rankingResultado" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- Aba de Objetivos -->
            <div class="tab-pane fade" id="objetivos" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sugest√µes por Objetivo</h5>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <select class="form-select" id="objetivoSelect">
                                    <option value="hipertrofia">Hipertrofia</option>
                                    <option value="emagrecimento">Emagrecimento</option>
                                    <option value="equilibrada">Dieta Equilibrada</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-3" onclick="buscarSugestoes()">Buscar Sugest√µes</button>
                        <div id="sugestoesResultado" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let carnesDisponiveis = [];
        let dadosComparacao = null;

        async function inicializar() {
            const response = await fetch('/api/carnes');
            const dados = await response.json();
            carnesDisponiveis = Object.keys(dados).sort();
            
            const container = document.getElementById('selectContainer');
            
            for (let i = 0; i < 3; i++) {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                
                const select = document.createElement('select');
                select.className = 'form-select carne-select';
                select.id = `carne${i + 1}`;
                
                select.innerHTML = `
                    <option value="">Selecione uma carne</option>
                    ${carnesDisponiveis.map(carne => 
                        `<option value="${carne}">${carne}</option>`
                    ).join('')}
                `;
                
                col.appendChild(select);
                container.appendChild(col);
            }
        }

        async function compararCarnes() {
            const carnes = Array.from(document.querySelectorAll('.carne-select'))
                .map(select => select.value)
                .filter(value => value);

            if (carnes.length === 0) {
                alert('Selecione pelo menos uma carne!');
                return;
            }

            const response = await fetch('/api/comparar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ carnes })
            });

            const data = await response.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            dadosComparacao = data.resultados;
            atualizarTabela(data.resultados, carnes);
            atualizarGraficos(data.resultados, carnes);
            document.getElementById('resultado').style.display = 'block';
        }

        function atualizarTabela(resultados, carnes) {
            const tabela = document.getElementById('tabelaComparacao');
            const thead = tabela.querySelector('thead tr');
            const tbody = tabela.querySelector('tbody');

            thead.innerHTML = '<th>Nutriente</th>';
            tbody.innerHTML = '';

            carnes.forEach(carne => {
                thead.innerHTML += `<th>${carne}</th>`;
            });

            for (const [nutriente, valores] of Object.entries(resultados)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${nutriente.replace('_', ' ').toUpperCase()}</td>`;

                carnes.forEach(carne => {
                    const valor = valores[carne];
                    let texto = valor.valor.toFixed(1);
                    
                    if (carne !== carnes[0]) {
                        const diff = valor.diferenca;
                        const classe = diff > 0 ? 'positive' : 'negative';
                        texto += ` <span class="${classe}">(${diff.toFixed(1)}%)</span>`;
                    }
                    
                    tr.innerHTML += `<td>${texto}</td>`;
                });

                tbody.appendChild(tr);
            }
        }

        function atualizarGraficos(resultados, carnes) {
            const proteinas = carnes.map(carne => resultados.proteinas[carne].valor);
            const gorduras = carnes.map(carne => resultados.gorduras_totais[carne].valor);

            const configProteinas = {
                type: 'bar',
                data: {
                    labels: carnes,
                    datasets: [{
                        label: 'Prote√≠nas (g)',
                        data: proteinas,
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compara√ß√£o de Prote√≠nas'
                        }
                    }
                }
            };

            const configGorduras = {
                type: 'bar',
                data: {
                    labels: carnes,
                    datasets: [{
                        label: 'Gorduras Totais (g)',
                        data: gorduras,
                        backgroundColor: '#FFA726'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compara√ß√£o de Gorduras Totais'
                        }
                    }
                }
            };

            new Chart(document.getElementById('graficoProteinas'), configProteinas);
            new Chart(document.getElementById('graficoGorduras'), configGorduras);
        }

        async function gerarRanking() {
            const nutriente = document.getElementById('nutrienteSelect').value;
            const ordem = document.getElementById('ordemSelect').value;
            
            const response = await fetch(`/api/ranking/${nutriente}?ordem=${ordem}`);
            const ranking = await response.json();
            
            const resultado = document.getElementById('rankingResultado');
            resultado.innerHTML = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Carne</th>
                                <th>${nutriente.replace('_', ' ').toUpperCase()}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ranking.map((item, index) => `
                                <tr>
                                    <td>${index + 1}¬∫</td>
                                    <td>${item.nome}</td>
                                    <td>${item.valor.toFixed(1)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function buscarSugestoes() {
            const objetivo = document.getElementById('objetivoSelect').value;
            
            const response = await fetch(`/api/sugestoes/${objetivo}`);
            const sugestoes = await response.json();
            
            const resultado = document.getElementById('sugestoesResultado');
            resultado.innerHTML = `
                <div class="alert alert-info">
                    Melhores op√ß√µes para ${objetivo}:
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Carne</th>
                                <th>Pontua√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sugestoes.map((item, index) => `
                                <tr>
                                    <td>${index + 1}¬∫</td>
                                    <td>${item.nome}</td>
                                    <td>${item.pontuacao.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tabela = document.getElementById('tabelaComparacao');
            doc.autoTable({ html: tabela });
            
            doc.save('comparacao-nutricional.pdf');
        }

        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(document.getElementById('tabelaComparacao'));
            XLSX.utils.book_append_sheet(wb, ws, "Compara√ß√£o");
            XLSX.writeFile(wb, "comparacao-nutricional.xlsx");
        }

        inicializar();
    </script>
</body>
</html>